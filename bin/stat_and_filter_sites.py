#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright Â© 2021 Ye Chang yech1990@gmail.com
# Distributed under terms of the MIT license.
#
# Created: 2021-11-26 00:58

import sys

import numpy as np
import pandas as pd
from pyfaidx import Fasta

genome = Fasta(sys.argv[1])

motif2slope = {
    "AA-AA": 2.4385395573366258,
    "AA-AC": 213.68421052631578,
    "AA-AG": 1.5766984061794747,
    "AA-AT": 8.152143754777837,
    "AA-CA": 4.339758962994444,
    "AA-CC": 5.1918874122777225,
    "AA-CG": 3.9642677828914166,
    "AA-CT": 5.2196200461600855,
    "AA-GA": 9.509935564704728,
    "AA-GC": 4.721413908621832,
    "AA-GG": 15.595523927044246,
    "AA-GT": 12.23033918408568,
    "AA-TA": 2.9493645355924953,
    "AA-TC": 7.594175236012856,
    "AA-TG": 6.02090780041643,
    "AA-TT": 1.6644612343934329,
    "AC-AA": 1.0,
    "AC-AC": 4.25,
    "AC-AG": 1.213409093864501,
    "AC-AT": 6.585365853658535,
    "AC-CA": 3.2259393597369304,
    "AC-CC": 4.588235294117647,
    "AC-CG": 1.3400654439914923,
    "AC-CT": 1.0690478822478113,
    "AC-GA": 9.10657052230668,
    "AC-GC": 9.62687872470794,
    "AC-GG": 5.108529688969027,
    "AC-GT": 4.019785434672091,
    "AC-TA": 5.071656050955413,
    "AC-TC": 5.085217176568204,
    "AC-TG": 13.554803128695248,
    "AC-TT": 14.574384182861102,
    "AG-AA": 1.7592420783933833,
    "AG-AC": 1.5546772978210932,
    "AG-AG": 1.532667638787417,
    "AG-AT": 2.6732788141613395,
    "AG-CA": 6.5477334566319625,
    "AG-CC": 1.5378930397496422,
    "AG-CG": 3.7114632582188594,
    "AG-CT": 1.9346441586818701,
    "AG-GA": 2.3275467063470754,
    "AG-GC": 3.2840285556991655,
    "AG-GG": 3.3223436875506986,
    "AG-GT": 2.6181016560835833,
    "AG-TA": 2.0589189231099034,
    "AG-TC": 1.4539200819807383,
    "AG-TG": 1.857405843711445,
    "AG-TT": 1.708382320117731,
    "AT-AA": 450.0,
    "AT-AC": 6.240220196391871,
    "AT-AG": 8.435354149063992,
    "AT-AT": 10.812646034002297,
    "AT-CA": 9.924283464566932,
    "AT-CC": 2.689262472885033,
    "AT-CG": 14.81592705742884,
    "AT-CT": 15.061035926636336,
    "AT-GA": 12.047283597294284,
    "AT-GC": 10.736860204439235,
    "AT-GG": 9.44370729255242,
    "AT-GT": 19.387566239365537,
    "AT-TA": 19.710248881189358,
    "AT-TC": 7.265191166379965,
    "AT-TG": 16.27502171225519,
    "AT-TT": 14.546715501618005,
    "CA-AA": 5.956312944653425,
    "CA-AC": 3.238030056883576,
    "CA-AG": 11.850558333773261,
    "CA-AT": 5.315741305674191,
    "CA-CA": 2.688565109895819,
    "CA-CC": 2.6056071277956945,
    "CA-CG": 1.9726748460305203,
    "CA-CT": 3.3986935107157876,
    "CA-GA": 7.026867382882001,
    "CA-GC": 2.703781685852071,
    "CA-GG": 6.6276221917350195,
    "CA-GT": 22.946675083345983,
    "CA-TA": 11.412303190166423,
    "CA-TC": 9.851652994992575,
    "CA-TG": 6.155355845622875,
    "CA-TT": 9.732837441085303,
    "CC-AA": 1000,
    "CC-AC": 1.75,
    "CC-AG": 7.496981448669205,
    "CC-AT": 15.312873470956681,
    "CC-CA": 21.0,
    "CC-CC": 1.3321956409527118,
    "CC-CG": 17.75331987649538,
    "CC-CT": 1000,
    "CC-GA": 7.150795412857562,
    "CC-GC": 5.735799602098024,
    "CC-GG": 11.740338531989998,
    "CC-GT": 7.117068028053384,
    "CC-TA": 120.0,
    "CC-TC": 9.112988149498635,
    "CC-TG": 26.04856447456078,
    "CC-TT": 12.100047313035073,
    "CG-AA": 2.8071314758780677,
    "CG-AC": 1.872164162183021,
    "CG-AG": 2.0034468407346107,
    "CG-AT": 2.160810339207686,
    "CG-CA": 1.3240901366541264,
    "CG-CC": 1.3296679653443553,
    "CG-CG": 1.6749522040451283,
    "CG-CT": 1.2972280205425624,
    "CG-GA": 2.816430665388414,
    "CG-GC": 2.7863671573308695,
    "CG-GG": 2.838245829788897,
    "CG-GT": 2.5201060039185923,
    "CG-TA": 1.782859453477351,
    "CG-TC": 1.3469887008443986,
    "CG-TG": 1.6228530543317286,
    "CG-TT": 1.5493007462651858,
    "CT-AA": 6.899630639485113,
    "CT-AC": 20.645878673867912,
    "CT-AG": 21.58034872603506,
    "CT-AT": 9.074991621731083,
    "CT-CA": 2.510940919037199,
    "CT-CC": 11.738268341044282,
    "CT-CG": 10.326756684331308,
    "CT-CT": 11.172965031362665,
    "CT-GA": 10.630608558868257,
    "CT-GC": 5.906233663470133,
    "CT-GG": 16.69237661717694,
    "CT-GT": 23.759037837336066,
    "CT-TA": 8.392427601192052,
    "CT-TC": 6.234785789903762,
    "CT-TG": 19.16984535540217,
    "CT-TT": 5.956501228704369,
    "GA-AA": 7.059735177729962,
    "GA-AC": 6.854487622131594,
    "GA-AG": 9.036013499426215,
    "GA-AT": 3.236414080899431,
    "GA-CA": 9.300713192985159,
    "GA-CC": 2.941116754900658,
    "GA-CG": 5.439738019931101,
    "GA-CT": 3.699976086742404,
    "GA-GA": 5.606903519736879,
    "GA-GC": 8.716513460562053,
    "GA-GG": 14.948947668885872,
    "GA-GT": 12.197248396473539,
    "GA-TA": 9.858935644541303,
    "GA-TC": 6.036171953032965,
    "GA-TG": 14.458208119997611,
    "GA-TT": 6.938483392403191,
    "GC-AA": 4.818007749220193,
    "GC-AC": 3.745035058239304,
    "GC-AG": 10.205008807843965,
    "GC-AT": 19.60265605408258,
    "GC-CA": 5.170175506588308,
    "GC-CC": 10.643885657180435,
    "GC-CG": 15.274935697463714,
    "GC-CT": 14.216775568960857,
    "GC-GA": 16.174743673849004,
    "GC-GC": 11.264277038061623,
    "GC-GG": 24.8732529452272,
    "GC-GT": 26.15400826386017,
    "GC-TA": 9.879887651640102,
    "GC-TC": 20.674148565275964,
    "GC-TG": 19.77284896405298,
    "GC-TT": 15.168637064879835,
    "GG-AA": 3.1313027587486477,
    "GG-AC": 1.8874212151934753,
    "GG-AG": 2.957519468335507,
    "GG-AT": 3.2650955583234498,
    "GG-CA": 2.580919180856874,
    "GG-CC": 2.3428281488100913,
    "GG-CG": 3.306984227472942,
    "GG-CT": 2.3301518302483526,
    "GG-GA": 3.060306930281873,
    "GG-GC": 3.92616140916791,
    "GG-GG": 3.648382430782771,
    "GG-GT": 3.988573199447618,
    "GG-TA": 2.707145670734084,
    "GG-TC": 2.005982604824663,
    "GG-TG": 2.300526098918341,
    "GG-TT": 1.9924515461452281,
    "GT-AA": 22.87918455712134,
    "GT-AC": 7.320862931312066,
    "GT-AG": 24.362750930498677,
    "GT-AT": 22.48528342255226,
    "GT-CA": 19.170166619015546,
    "GT-CC": 7.568030251487812,
    "GT-CG": 16.57912167946786,
    "GT-CT": 19.369978913963166,
    "GT-GA": 10.918968215443018,
    "GT-GC": 16.55563024787285,
    "GT-GG": 26.656209974328807,
    "GT-GT": 26.269598001308854,
    "GT-TA": 6.2276515334893325,
    "GT-TC": 23.251960827997408,
    "GT-TG": 26.852844461946685,
    "GT-TT": 18.739294870101148,
    "TA-AA": 9.393075793819563,
    "TA-AC": 3.6561980473119373,
    "TA-AG": 13.710139770717264,
    "TA-AT": 7.5039818245711425,
    "TA-CA": 3.085361599861613,
    "TA-CC": 5.014812249966976,
    "TA-CG": 6.407735734705522,
    "TA-CT": 5.623644588319188,
    "TA-GA": 7.175211659269246,
    "TA-GC": 10.452899525137955,
    "TA-GG": 16.239110340407247,
    "TA-GT": 13.1164770176923,
    "TA-TA": 9.640914962211925,
    "TA-TC": 18.26847932073484,
    "TA-TG": 13.59903917868656,
    "TA-TT": 11.049731101945367,
    "TC-AA": 22.15993380986668,
    "TC-AC": 34.140447343895616,
    "TC-AG": 19.245126579666792,
    "TC-AT": 12.111384890544926,
    "TC-CA": 3.0960640262658226,
    "TC-CC": 14.694293613615104,
    "TC-CG": 7.9574627996994005,
    "TC-CT": 16.77274762664134,
    "TC-GA": 9.796960693612904,
    "TC-GC": 9.748293172298068,
    "TC-GG": 36.100072623320706,
    "TC-GT": 42.375348598001004,
    "TC-TA": 2.664235484903278,
    "TC-TC": 16.503512450761352,
    "TC-TG": 16.878083960540888,
    "TC-TT": 28.282974598930018,
    "TG-AA": 2.305693204862426,
    "TG-AC": 3.6360290019370276,
    "TG-AG": 3.519375680858327,
    "TG-AT": 3.32692840823027,
    "TG-CA": 4.350551106506399,
    "TG-CC": 1.9583601899496441,
    "TG-CG": 3.2157438069490434,
    "TG-CT": 1.8870826738021962,
    "TG-GA": 5.662239869714855,
    "TG-GC": 5.3287477617951335,
    "TG-GG": 4.526042720236343,
    "TG-GT": 4.887520782908772,
    "TG-TA": 2.244833664962708,
    "TG-TC": 2.7851197477056866,
    "TG-TG": 2.233720764696686,
    "TG-TT": 2.370804836766736,
    "TT-AA": 10.274622337318833,
    "TT-AC": 9.595587479649978,
    "TT-AG": 16.95134259271527,
    "TT-AT": 15.867618144278993,
    "TT-CA": 15.340713768313957,
    "TT-CC": 8.888580985210522,
    "TT-CG": 17.15775948876186,
    "TT-CT": 20.471193777247326,
    "TT-GA": 16.723121819505863,
    "TT-GC": 9.958538589058962,
    "TT-GG": 17.22380153773412,
    "TT-GT": 17.821334734180937,
    "TT-TA": 9.255714120485388,
    "TT-TC": 14.799763332112077,
    "TT-TG": 17.29952627283697,
    "TT-TT": 17.545643882161404,
}


def get_motif(chrom, pos, strand, pad=10):
    if strand == "+":
        s = genome[chrom][pos - 1 - pad : pos + pad].seq.upper()
    else:
        s = genome[chrom][
            pos - 1 - pad : pos + pad
        ].reverse.complement.seq.upper()
    return s


df = pd.read_csv(sys.argv[2], sep="\t", low_memory=False)

site_names = list(df.columns)[:4]
stat_names = list(df.columns)[4:]

df["input_depth"] = df[
    [c for c in stat_names if "input" in c and "_depth" in c]
].min(axis=1)
df["input_ratio"] = df[
    [c for c in stat_names if "input" in c and "_ratio" in c]
].mean(axis=1)
df["input_mut"] = df[
    [c for c in stat_names if "input" in c and "_mut" in c]
].sum(axis=1)

df["treated_depth"] = df[
    [c for c in stat_names if "treated" in c and "_depth" in c]
].min(axis=1)
df["treated_ratio"] = df[
    [c for c in stat_names if "treated" in c and "_ratio" in c]
].mean(axis=1)
df["treated_mut"] = df[
    [c for c in stat_names if "treated" in c and "_mut" in c]
].sum(axis=1)

# "treated_depth >= 10 and treated_mut >= 3 and treated_ratio >= 0.05 and (input_mut < 2 or input_ratio < 0.025)",
df = (
    df.query(
        "treated_depth >= 20 and treated_mut >= 3 and treated_ratio >= 0.05 and (input_mut < 2 or input_ratio < 0.025)",
    )
    .assign(ratio=lambda x: x["treated_ratio"])
    .assign(
        motif_long=lambda x: np.vectorize(get_motif, otypes=[str])(
            x["chr"], x["pos"], x["strand"]
        )
    )
    .assign(
        motif=lambda x: x["motif_long"].str[8:10]
        + "-"
        + x["motif_long"].str[11:13]
    )
    .assign(frac=lambda x: np.clip(x.ratio * x.motif.map(motif2slope), 0, 1))
)

df = df.loc[:, site_names + ["motif_long", "motif", "ratio", "frac"]]


if len(sys.argv) > 3:
    out_file = sys.argv[3]
else:
    out_file = sys.stdout

df.to_csv(out_file, sep="\t", index=False)
